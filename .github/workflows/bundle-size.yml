name: Bundle Size Comparison

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  compare-bundle-size:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch all history for all branches

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16" # Adjust the Node.js version as needed

      - name: Install dependencies
        run: npm ci

      - name: Build the project (PR branch)
        run: npm run build

      - name: Measure bundle size (PR branch)
        run: npm run size

      - name: Copy bundle size output (PR branch)
        run: cp bundle-size.json pr-bundle-size.json

      - name: Checkout base branch
        run: git checkout ${{ github.event.pull_request.base.ref }}

      - name: Install dependencies (base branch)
        run: npm ci

      - name: Build the project (base branch)
        run: npm run build

      - name: Measure bundle size (base branch)
        run: npm run size

      - name: Copy bundle size output (base branch)
        run: cp bundle-size.json base-bundle-size.json

      - name: Compare bundle sizes
        id: compare
        run: |
          echo "Beregner forskjell i bundle-st√∏rrelse..."

          # Extract the 'size' value from the JSON output for both PR and base branches
          PR_SIZE_KB=$(jq '.[0].size' pr-bundle-size.json)
          BASE_SIZE_KB=$(jq '.[0].size' base-bundle-size.json)

          # Convert sizes from kilobytes to bytes
          PR_SIZE=$(echo "$PR_SIZE_KB * 1024" | bc)
          BASE_SIZE=$(echo "$BASE_SIZE_KB * 1024" | bc)

          # Calculate the difference and percentage change
          DIFF=$(echo "$PR_SIZE - $BASE_SIZE" | bc)
          PERCENT_CHANGE=$(echo "scale=2; ($DIFF / $BASE_SIZE) * 100" | bc)

          # Set outputs for use in the next step
          echo "PR_SIZE=$PR_SIZE" >> $GITHUB_OUTPUT
          echo "BASE_SIZE=$BASE_SIZE" >> $GITHUB_OUTPUT
          echo "DIFF=$DIFF" >> $GITHUB_OUTPUT
          echo "PERCENT_CHANGE=$PERCENT_CHANGE" >> $GITHUB_OUTPUT

      - name: Post comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const prSize = Number('${{ steps.compare.outputs.PR_SIZE }}');
            const baseSize = Number('${{ steps.compare.outputs.BASE_SIZE }}');
            const diff = Number('${{ steps.compare.outputs.DIFF }}');
            const percentChange = Number('${{ steps.compare.outputs.PERCENT_CHANGE }}').toFixed(2);

            // Function to format bytes into human-readable units
            const formatBytes = (bytes) => {
              const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
              if (bytes == 0) return '0 Bytes';
              const i = parseInt(Math.floor(Math.log(Math.abs(bytes)) / Math.log(1024)), 10);
              return `${(bytes / Math.pow(1024, i)).toFixed(2)} ${sizes[i]}`;
            };

            let message = '';

            if (diff > 0) {
              message = `üî∫ **Bundle-st√∏rrelse √∏kte** med **${formatBytes(diff)}** (${percentChange}%)\n\n` +
                        `**Base-st√∏rrelse:** ${formatBytes(baseSize)}\n` +
                        `**PR-st√∏rrelse:** ${formatBytes(prSize)}`;
            } else if (diff < 0) {
              message = `üîª **Bundle-st√∏rrelse minket** med **${formatBytes(Math.abs(diff))}** (${Math.abs(percentChange)}%)\n\n` +
                        `**Base size:** ${formatBytes(baseSize)}\n` +
                        `**PR size:** ${formatBytes(prSize)}`;
            } else {
              message = `‚úÖ **Ingen endring i bundle-st√∏rrelse.**\n\n` +
                        `**Bundle-st√∏rrelse:** ${formatBytes(prSize)}`;
            }

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: prNumber,
              body: message
            });
